{
    "id": "rpt_supload",
    "name": "rpt_supload",
    "label": "2016統計報表-生產業者未回傳名單",
    "meta": [
        {
            "id": "sid",
            "label": "編號"
        },
        {
            "id": "cId",
            "label": "統編/證號"
        },
        {
            "id": "cName",
            "label": "商業名稱"
        },
        {
            "id": "scityId",
            "label": "地區"
        },
        {
            "id": "checkDate",
            "label": "未回傳年月",
            "dt": "date",
            "ft": "yyyy/MM/dd"
        },
        {
            "id": "e_dt",
            "eval": "$['dtText']=($.dt==1) ? '出貨' : '進貨' "
        },
        {
            "id": "e_i",
            "eval": "$['sid']=$.$i"
        }
    ],
    "query": {
        "$act": "rows",
        "$cmd": [
            "select t1.baphiqId , t1.checkDate , t1.dt , isnull(t2.qty,0) qty , t1.cName , t1.cId , newId,oldId, t1.cityId , t1.scityId from ( ",
            "select  checkdate  , baphiqId , 2 as dt , newId,oldId, ",
            "case when isnull(len(newId),0)>0 then newId else oldId end as cId , ",
            "cName , cityId ,  cityIdText as scityId ",
            "from psSaleMonth a cross join psRefStore b ",
            "where b.stype='4' and ctype='2' and checkDate >= ${sdp1,date} and checkDate< ${sdp2,date} ) t1 ",
            "left join ( ",
            "select baphiqId , 2 as dt  , dbo.fn_get2month(purchasedt) checkdate , sum(purchaseQty) qty ",
            "from psSaleSP ",
            "where purchaseDt>= ${sdp1,date} and purchaseDt < ${sdp2,date} and ct < ${limited,date} ",
            "group by baphiqId,  dbo.fn_get2month(purchasedt) ",
            "union ",
            "select baphiqId , 2 as dt  ,  dbo.fn_get2month(purchasedt) checkdate , sum(purchaseQty) qty ",
            "from psSaleSS ",
            "where purchaseDt >= ${sdp1,date} and purchaseDt < ${sdp2,date} and ct < ${limited,date} ",
            "group by baphiqId,  dbo.fn_get2month(purchasedt) ) t2 ",
            "on (t1.baphiqId = t2.baphiqId and t1.checkDate = t2.checkDate ) ",
            "where isnull(t2.qty,0) = 0 ",
            "${=,t1.cityId,string,cityId}",
            "${=,t1.dt,string,dt}",
            "${or}${$all,t1.newId,string,cid}${$all,t1.oldId,string,cid}${$all,t1.cName,string,cid}${end}"
        ],
        "$orderby": "baphiqid, checkdate , dt"
    },
    "export": {
        "$rem": "",
        "$act": "rows",
        "$ref_cmd": "query",
        "$before": "e_i,e_dt",
        "$rem_fields": "sid,cId,cName,scityId,dtText,checkDate",
        "$fields": "sid,cId,cName,scityId"
    }
}


