{
    "id": "rpt_brcode_area",
    "name": "rpt_brcode_area",
    "label": "零售品項進銷總量異常統計",
    "meta": [
        {"id":"cname","label":"業者名稱","eval":"$['cname']=$.cName+'('+($.?newId.length()==6?$.newId:$.oldId)+')'"},
        {"id":"cityIdText","label":"地區"},
        {"id":"qty","label":"異常品項數量"}
    ],
    "query": {
        "$act": "rows",
        "$cmd": [
            " select a.* , b.cName, b.oldId, b.newId, b.cityId , b.cityIdText from ( ",
            " select  baphiqId , count(*) qty from ",
            " (select baphiqId , barcode , stock , inQty , outQty , (outQty-stock-inQty) errQty from ",
            " (select baphiqId ,  barcode , sum(stock) stock , sum( isnull(inQty,0)) inQty , sum(isnull(outQty,0)) outQty ",
            " from stat_store_barcode ",
            " where yymm=${dp,int} ",
            " group by   baphiqId ,  barcode) t ",
            " where  (outQty-stock-inQty)>0 ) t ",
            " group by baphiqid ) a join psRefStore b on (a.baphiqId= b.baphiqId) " ,
            " where 1=1  ${=,cityId,string,cityid} "
        ],
        "$orderby": "baphiqId"
    },
    "detail": {
        "$act": "rows",
        "$cmd": [
            " select a.barcode, b.pesticideName, b.formCode , b.contents , ", 
            " a.stock , a.inQty , a.outQty ,  (isnull(outQty,0)-isnull(stock,0)-isnull(inQty,0)) errQty ",
            " from stat_store_barcode a left join barcode_view b ",
            " on (a.barcode = b.barcode) ",
            " where   (isnull(outQty,0)-isnull(stock,0)-isnull(inQty,0))>0 " ,
            " and baphiqId = ${baphiqId,string} ${=,yymm,int,dp} "
        ],
        "$orderby": "errQty desc,barcode"
    },

    "export": {
        "$rem": "",
        "$act": "rows",
        "$ref_cmd": "query",
        "$ref_orderby": "query",
        "$before": "cname",
        "$fields": "cname,cityIdText,qty"
    }
}
