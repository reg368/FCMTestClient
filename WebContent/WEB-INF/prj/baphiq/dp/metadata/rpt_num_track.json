{
    "id": "stat_num_track",
    "name": "statNumTrack",
    "label": "2016統計報表-批號追蹤",
    "meta": [
        {"id":"gen","label":"製表日期：","eval":"$['gen']=$f.df('yyyy/MM/dd',$now)"},
        {"id":"pesticideName","label":"農藥普通名稱"},   
        {"id":"form","label":"劑型"},   
        {"id":"contents","label":"含量"},
        {"id":"barcode","label":"農藥條碼"},
        {"id":"makedt","label":"製造日期"},
        {"id":"makeid","label":"農藥批號"},
        {"id":"domManufName","label":"製造商"},
        {"id":"domManufId","label":"統一編號"},
        {"id":"qty1","label":"總出貨量"},
        {"id":"e_name","eval":"$['name']=$.pesticideName"},
        {"id":"e_form","eval":"$['form']=$.formName+'('+$.formCode.trim()+')'"},
        {"id":"e_makedt","eval":"$['makedt']=$f.replace($$.?makedt,'-','/')"},
        {"id":"e_makeid","eval":"$['makeid']=$$.?makeid"},
        {"id":"e_qty1","eval":"$['qty1']=$.qty"},
        {"id":"sid","label":"編號"},
        {"id":"sell","label":"業者名稱"},
        {"id":"cityIdText","label":"地區"},
        {"id":"buy","label":"客戶名稱"},
        {"id":"qty2","label":"數量"},
        {"id":"e_sell","eval":"$['sell']=$.cName+'('+ ($.?newId.length()>0? $.newId : $.oldId)  +')'"},    
        {"id":"e_buy","eval":"$['buy']=$.bcName+'('+$.bcId+')'"},
        {"id":"e_i","eval":"$['sid']=$.$i+1"},
        {"id":"e_qty2","eval":"$['qty2']=$.qty"},
        {"id":"e_barcode","eval":"$['barcode']='=\"'+$.barcode+' \"'"}
    ],
    "query_disable_20160830": {
        "$rem" : "20160830改版",
        "$act": "rows",
        "$cmd": [
            "select a.baphiqId, a.barcode, a.makeId, a.purchaseDt, a.purchaseQty , ",
            "b.cName scName, case when isnull(len(b.newId),0)>0 then b.newId else b.oldId end as sellId, ",
            "b.cityId , (select cityname from cityset_t x where x.cityId=b.cityId ) as scityId , ",
            "c.cName bcName, case when isnull(len(c.newId),0)>0 then c.newId else c.oldId end as buyId, ",
            "d.volume , d.unit , d.pesticideName , d.contents ",
            "from psSaleSS a ",
            "left join psRefStore b on (a.baphiqId = b.baphiqId) ",
            "left join psRefStore c on (a.bcid = c.oldId or a.bcid = c.newId) ",
            "left join (select barcode, volume, unit , pesticideName , contents from barcode_t x join pesticidelic_t y ",
            "on (x.lictype = y.lictype and x.licNo = y.licNo)) d ",
            "on (a.barcode=d.barcode) ",
            "where 1=1 ",
            "${>,purchaseDt,date,dp1}",
            "${<=,purchaseDt,date,dp2}",
            "${=,b.cityId,string,cityId}",
            "${$all,d.pesticideName,string,pesticideName}",
            "${$all,a.barcode,string,barcode}",
            "${$all,makeId,string}",
            "${or}${$all,b.newId,string,sell}${$all,b.oldId,string,sell}${$all,b.cName,string,sell}${end}",
            "${or}${$all,c.newId,string,buy}${$all,c.oldId,string,buy}${$all,c.cName,string,buy}${end}"
        ],
         "$orderby": "purchaseDt desc, baphiqId"
    },
    
    "query":{
        "$act": "rows",
        "$cmd": [ " select baphiqId, cName,oldId,newId,cityId, cityIdText , bcId , bcName , sum(purchaseQty) qty , max(ct) ct from psSaleSSTrackNumView  " ,
            " where barcode = ${barcode,string,barcode}" ,
            " ${=,makeid,string} ${=,makedt,string} ${=,cityId,string,cityid}" ,
            " group by  baphiqId,cName,oldId,newId,cityId, cityIdText , bcId , bcName"
        ],
        "$orderby": "cityid,baphiqId"
    },
    
   "query_barcode" :{
        "$act": "row",
        "$cmd": [ 
            " select * from " , 
            " (select barcode ,  sum(purchaseQty) qty  from psSaleSS " ,
            " where ds in ('1','2') ",
            "  and barcode=${barcode,string,barcode} " , 
            " ${=,makeid,string} ${=,cast(makedt as date),string,makedt} " ,
            " group by  barcode  ) q1 ",
            " left join " ,
           " (select b.pesticideName , b.formName,   b.formCode , b.contents , a.barcode , b.domManufName ,b.domManufId ",
           " from barcode_t a join PesticideLic_T b on (a.licType = b.licType and a.licNo = b.licNo) ) q2 ",
           " on(q1.barcode = q2.barcode) " 
        ]
   },
   
    "detail":{
        "$act": "rows",
        "$cmd": [ " select * from psSaleSSTrackNumView  " ,
            " where barcode = ${barcode,string,barcode}" ,
            " and bcid = ${bcid,string} ",
            " ${=,makeid,string} ${=,makedt,string}"
        ],
        "$orderby": "makedt desc"
    },
    
   "export" :{
        "$rem":"",
        "$act":"rows",
        "$ref_cmd" : "query",
        "$before":"e_i,e_sell,e_buy,e_qty2",
        "$fields" : "sid,sell,cityIdText,buy,qty2"
    },
    
    "export_barcode" :{
        "$rem":"",
        "$rem_style":"row,col , default row",
        "style":"col",
        "$act":"rows",
        "$ref_cmd" : "query_barcode",
        "$before":"gen,e_form,e_makedt,e_makeid,e_qty1,e_barcode",
        "$fields" : "gen,pesticideName,form,contents,barcode,makedt,makeid,domManufName,domManufId,qty1"
    }


}
