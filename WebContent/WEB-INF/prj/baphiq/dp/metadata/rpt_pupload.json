{
    "id": "rpt_pupload",
    "name": "rpt_pupload",
    "label": "2016統計報表-販賣業者未回傳名單",
    "meta": [
        {
            "id": "sid",
            "label": "編號"
        },
        {
            "id": "cId",
            "label": "統編/證號"
        },
        {
            "id": "cName",
            "label": "商業名稱"
        },
        {
            "id": "scityId",
            "label": "地區"
        },
        {
            "id": "checkDate",
            "label": "未回傳年月",
            "ft":"yyyy/MM/dd",
            "dt":"date"
        },
        {
            "id": "e_dt",
            "eval": "$['dtText']=($.dt==1) ? '出貨' : '進貨' "
        },
        {
            "id": "e_i",
            "eval": "$['sid']=$.$i"
        }
    ],
    "query_v1": {
        "$rem": "20160321改版",
        "$act": "rows",
        "$cmd": [
            "select t1.baphiqId , t1.checkDate , t1.dt , isnull(t2.qty,0) qty , t1.cName ,t1.oldId, t1.newId, t1.cId , t1.cityId , t1.scityId from ",
            "( select a.checkDate , baphiqId , 1 as dt , oldId, newId, ",
            "case when isnull(len(newId),0)>0 then newId else oldId end as cId , ",
            "cName , cityId ,  cityIdText as scityId ",
            "from psSaleMonth a cross join psRefStore b ",
            "where checkDate>= ${sdp1,string} and  checkDate <= ${sdp2,string} ",
            "union ",
            "select a.checkDate , baphiqId , 2 as dt , oldId , newId, ",
            "case when isnull(len(newId),0)>0 then newId else oldId end as cId , ",
            "cName , cityId ,cityIdText as scityId ",
            "from psSaleMonth a cross join psRefStore b ",
            "where checkDate>= ${sdp1,string} and  checkDate <= ${sdp2,string} ) t1 ",
            "left join ",
            "( select baphiqId , dt , checkDate , sum(qty) qty from ",
            "(select baphiqId , 2 as dt ,  convert(varchar(7),purchaseDt , 120) checkDate , purchaseQty qty from psSaleSS ",
            "where convert(varchar(7),purchaseDt , 120) >=${sdp1,string} and convert(varchar(7),purchaseDt , 120) <=${sdp2,string} ",
            "union  all ",
            "select baphiqId , 2 as dt ,  convert(varchar(7),purchaseDt , 120) checkDate , purchaseQty qty from psSaleSP ",
            "where convert(varchar(7),purchaseDt , 120) >=${sdp1,string} and convert(varchar(7),purchaseDt , 120) <=${sdp2,string} ",
            "union all ",
            "select baphiqId , 1 as dt ,  convert(varchar(7),purchaseDt , 120) checkDate , purchaseQty qty from psSaleBS ",
            "where convert(varchar(7),purchaseDt , 120) >=${sdp1,string} and convert(varchar(7),purchaseDt , 120) <=${sdp2,string} ",
            "union all ",
            "select baphiqId,  dt, chkDate , 1  qty from psPaper ",
            "where chkDate >=${sdp1,string} and chkDate <=${sdp2,string}) t ",
            "group by baphiqId , dt , checkDate ) t2 ",
            "on ( t1.baphiqId = t2.baphiqId and t1.checkDate = t2.checkDate and t1.dt = t2.dt ) ",
            "where isnull(t2.qty,0) = 0 ",
            "${=,t1.cityId,string,cityId}",
            "${=,t1.dt,string,dt}",
            "${or}${$all,t1.newId,string,cid}${$all,t1.oldId,string,cid}${$all,t1.cName,string,cid}${end}"
        ],
        "$orderby": "baphiqid, checkdate , dt"
    },
    "query": {
        "$act": "rows",
        "$cmd": [
            "select t1.baphiqId , t1.checkDate , t1.dt , isnull(t2.qty,0) qty , t1.cName , t1.cId , t1.oldId, t1.newId, t1.cityId , t1.scityId from ( ",
            "select  checkdate  , baphiqId , 2 as dt , oldId, newId, ",
            "case when isnull(len(newId),0)>0 then newId else oldId end as cId , ",
            "cName , cityId ,  cityIdText as scityId ",
            "from psSaleSeason a cross join psRefStore b ",
            "where b.stype='0' and checkDate >= ${sdp1,date}  and checkDate < ${sdp2,date}  ) t1 ",
            "left join ( ",
            "select baphiqId , 2 as dt  ,  DATEADD(qq,DATEDIFF(qq,0,DATEADD(qq,0,purchaseDt)),0) checkdate , sum(purchaseQty) qty ",
            "from psSaleSP ",
            "where purchaseDt>= ${sdp1,date}  and purchaseDt < ${sdp2,date}  and ct<${limited,date} ",
            "group by baphiqId, DATEADD(qq,DATEDIFF(qq,0,DATEADD(qq,0,purchaseDt)),0) ",
            "union ",
            "select baphiqId , 2 as dt  ,  DATEADD(qq,DATEDIFF(qq,0,DATEADD(qq,0,purchaseDt)),0) checkdate , sum(purchaseQty) qty ",
            "from psSaleSS ",
            "where purchaseDt>= ${sdp1,date}  and purchaseDt < ${sdp2,date}   and ct<${limited,date} ",
            "group by baphiqId, DATEADD(qq,DATEDIFF(qq,0,DATEADD(qq,0,purchaseDt)),0) ",
            "union ",
            "select baphiqId ,  2 dt ,  DATEADD(qq,DATEDIFF(qq,0,DATEADD(qq,0,chkDate)),0)  checkdate , 1 qty ",
            "from psPaper ",
            "where dt='2' and chkDate >= ${sdp1,date}  and chkDate < ${sdp2,date}  ",
            "group by baphiqId , DATEADD(qq,DATEDIFF(qq,0,DATEADD(qq,0,chkDate)),0) ) t2 ",
            "on (t1.baphiqId = t2.baphiqId and t1.checkDate = t2.checkDate ) ",
            "where isnull(t2.qty,0) = 0 ",
            "${=,t1.cityId,string,cityId}",
            "${=,t1.dt,string,dt}",
            "${or}${$all,t1.newId,string,cid}${$all,t1.oldId,string,cid}${$all,t1.cName,string,cid}${end}"
        ],
        "$orderby": "baphiqid, checkdate , dt"
    },
    "export": {
        "$rem": "",
        "$act": "rows",
        "$ref_cmd": "query",
        "$before": "e_i,e_dt",
        "$rem_fields": "sid,cId,cName,scityId,dtText,checkDate",
        "$fields": "sid,cId,cName,scityId"
    }
}
